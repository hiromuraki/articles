## 1. 用户管理

将特定用户添加到 docker 组

```bash
usermod -aG docker <username>
```

## 2. 镜像管理

**查看本地镜像**

```bash
docker images
```

**拉取镜像**

```bash
docker pull <repository:tag>
```

**移除本地指定镜像**

通过镜像 ID 删除

```bash
docker rmi <image_id or repository:tag>
```

**通过镜像创建特定容器**

```bash
docker run --name <container_name> -d -p 80:80 -v /local:/container <repository:tag>
```

常用参数

| 参数名         | 说明                    |
| -------------- | ----------------------- |
| --name         | 创建的容器名            |
| --publish (-p) | 定义宿主机:容器端口映射 |
| --volume (-v)  | 定义宿主机:容器卷映射   |

## 3. 容器管理

**运行容器**

```bash
docker run <image_name>
```

常用参数

| 参数名             | 说明                       |
| ------------------ | -------------------------- |
| --detach (-d)      | 后台运行容器               |
| --tty              | 分配伪终端                 |
| --interactive (-i) | 交互模式，保持标准输入打开 |

**停止容器**

```bash
docker container stop <container_id_or_name>
```

**查看运行中的容器**

```bash
docker container ls
```

或者

```bash
docker ps
```

常用参数

| 参数名     | 说明         |
| ---------- | ------------ |
| --all (-a) | 显示所有容器 |

**查看特定容器的输出**

```bash
docker container logs <container_id_or_name>
```

常用参数

| 参数名        | 说明         |
| ------------- | ------------ |
| --follow (-f) | 保持追踪日志 |

**将后台容器拉到前台**

```bash
docker attach <container_id_or_name>
```

若要 detach，按下 `Ctrl` + `P` 后再按下 `Ctrl` + `Q`

**直接在特定容器中执行命令**

```bash
docker exec <container_id_or_name> <command>
```

常用参数

| 参数名             | 说明                       |
| ------------------ | -------------------------- |
| --tty (-t)         | 启用伪终端                 |
| --interactive (-i) | 保持标准输入打开（交互式） |

**清理已停止的容器**

```bash
docker container prune
```

**导出容器**

```bash
docker export <container_id_or_name> > container.tar
```

**导入容器**

```bash
cat container.tar | docker import - container_name
```

### 3.1. 容器编排

#### 3.1.1. Docker Compose

**启动服务**

```bash
docker compose up
```

常用参数

| 参数          | 说明           |
| ------------- | -------------- |
| --detach (-d) | 以分离模式运行 |
| --build       | 运行前构建     |
| --no-build    | 强制不构建     |
| --dry-run     | 干运行         |

**停止服务**

```bash
docker compose down
```

常用参数

| 参数      | 说明   |
| --------- | ------ |
| --dry-run | 干运行 |

### 3.2. 容器资源

#### 3.2.1. 卷

**列出命名卷**

```bash
docker volume list
```

**查看特定命名卷详情**

```bash
docker volume inspect <volume_name>
```

**创建卷**

```bash
docker volume create <volume_name>
```

**删除卷**

```bash
docker volume rm <volume_name>
```

**删除所有未被引用的卷**

```bash
docker volume prune
```

**备份与恢复卷数据**

备份

```bash
docker run --rm \
  --volumes-from <source_container> \
  -v $(pwd)/backups:/backup \
  alpine \
  tar czf /backup/backup_$(date +%Y%m%d_%H%M%S).tar.gz -C /path/to/backup .
```

工作流程

1. 创建基于 alpine 的临时容器，用后删除
2. 继承 `<source_container>` 的所有挂载
3. 挂载本地备份目录到容器内的 /backup 目录
4. 将指定路径的目录打包到 /backup 备份目录

恢复

```bash
docker run --rm \
  --volumes-from ollama \
  -v $(pwd)/backups:/backup \
  alpine \
  sh -c "rm -rf /path/to/backup/* && tar xzf /backup/backup.tar.gz -C /path/to/backup"
```

#### 3.2.2. 网络

## 4. 其他

### 4.1. CUDA

**在宿主机安装 NVIDIA Container Toolkit**

- Apt

```bash
curl -fsSL https://nvidia.github.io/libnvidia-container/gpgkey \
    | sudo gpg --dearmor -o /usr/share/keyrings/nvidia-container-toolkit-keyring.gpg
curl -fsSL https://nvidia.github.io/libnvidia-container/stable/deb/nvidia-container-toolkit.list \
    | sed 's#deb https://#deb [signed-by=/usr/share/keyrings/nvidia-container-toolkit-keyring.gpg] https://#g' \
    | sudo tee /etc/apt/sources.list.d/nvidia-container-toolkit.list
sudo apt-get update
sudo apt-get install -y nvidia-container-toolkit
```

- Yum/Dnf

```bash
curl -fsSL https://nvidia.github.io/libnvidia-container/stable/rpm/nvidia-container-toolkit.repo \
    | sudo tee /etc/yum.repos.d/nvidia-container-toolkit.repo
sudo yum install -y nvidia-container-toolkit
```
