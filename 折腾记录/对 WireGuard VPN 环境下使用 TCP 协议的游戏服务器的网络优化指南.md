# å¯¹ WireGuard VPN ç¯å¢ƒä¸‹ä½¿ç”¨ TCP åè®®çš„æ¸¸æˆæœåŠ¡å™¨çš„ç½‘ç»œä¼˜åŒ–æŒ‡å—

[TOC]

## 1. æ¦‚è¿°

åœ¨é€šè¿‡ WireGuard (WG) ç»„ç½‘æ­å»ºæ¸¸æˆæœåŠ¡å™¨ï¼ˆå¦‚ Minecraft Javaç‰ˆï¼‰æ—¶ï¼Œå¸¸é‡åˆ°â€œç‰©ç†å¸¦å®½å……è¶³ï¼Œä½†æ¸¸æˆå†…ä¸¥é‡å¡é¡¿ã€åœ°å›¾åŠ è½½ç¼“æ…¢â€çš„é—®é¢˜ã€‚

æœ¬æ–‡æ¡£åŸºäºå®é™…æ’æŸ¥æ¡ˆä¾‹ï¼Œè¯¦ç»†è¯´æ˜å¦‚ä½•è¯Šæ–­ **â€œé«˜ä¸¢åŒ…ã€ä½æŠ–åŠ¨â€** çš„çº¿è·¯ç‰¹å¾ï¼Œå¹¶é€šè¿‡è°ƒæ•´ **MTU** å’Œå¼€å¯ **TCP BBR** æ‹¥å¡æ§åˆ¶ç®—æ³•ï¼Œå°† TCP ä¼ è¾“é€Ÿåº¦ä» **4 Mbps æå‡è‡³ 45 Mbps+**ï¼Œå½»åº•è§£å†³æ‹¥å¡å¯¼è‡´çš„ç½‘ç»œæ€§èƒ½ç“¶é¢ˆã€‚

## 2. ç¯å¢ƒ

- **ç½‘ç»œæ¶æ„**ï¼šæ¸¸æˆå®¢æˆ·ç«¯ - ä¸­ç»§èŠ‚ç‚¹ - æ¸¸æˆæœåŠ¡ç«¯

```mermaid
graph LR
    %% å®šä¹‰èŠ‚ç‚¹
    subgraph Clients [å®¢æˆ·ç«¯ç¾¤ N]
        C1[å®¢æˆ·ç«¯ 1]
        C2[å®¢æˆ·ç«¯ 2]
        CN[å®¢æˆ·ç«¯ ...]
    end

    Relay[ä¸­ç»§æœåŠ¡å™¨ / VPN Server]
    
    GameServer[æ¸¸æˆæœåŠ¡ç«¯]

    %% ç‰©ç†/é€»è¾‘è¿æ¥
    C1 -- "WireGuard éš§é“" --> Relay
    C2 -- "WireGuard éš§é“" --> Relay
    CN -- "WireGuard éš§é“" --> Relay
    Relay -- "WireGuard éš§é“" --> GameServer

    %% æ ‡æ³¨å…³é”®ç‚¹
    classDef highlight fill:#f96,stroke:#333,stroke-width:2px;
    class Relay highlight;
    
    linkStyle default stroke-width:2px,fill:none,stroke:gray;
```

- **ç»„ç½‘å·¥å…·**ï¼šWireGuard
- **æµ‹è¯•å·¥å…·**ï¼šiperf3
- **ç›®æ ‡åº”ç”¨**ï¼šMinecraft Javaç‰ˆ (ä¾èµ– TCP)
- **æ“ä½œç³»ç»Ÿ**ï¼š
  - ä¸­ç»§èŠ‚ç‚¹ï¼šLinux
  - æœåŠ¡ç«¯ï¼šLinux
  - å®¢æˆ·ç«¯ï¼šWindows
- **ç½‘ç»œå¸¦å®½**ï¼š
  - å®¢æˆ·ç«¯ï¼šä¸Šè¡Œ 20 Mbpsï¼Œä¸‹è¡Œ 30 Mbps
  - æœåŠ¡ç«¯ï¼šä¸Šè¡Œ 100 Mbpsï¼Œä¸‹è¡Œ 100 Mbps
  - ä¸­ç»§èŠ‚ç‚¹ï¼šå³°å€¼ä¸Šè¡Œ 200 Mbpsï¼Œå³°å€¼ä¸‹è¡Œ 200 Mbps

æ³¨ï¼šæ‰€æœ‰æµ‹è¯•å¿…é¡»é’ˆå¯¹ **WireGuard å†…ç½‘ IP** è¿›è¡Œï¼Œä»¥ç¡®ä¿æµé‡ç»è¿‡åŠ å¯†éš§é“ã€‚

## 3. ç½‘ç»œè´¨é‡æ£€æµ‹ä¸åˆ†æ

åœ¨è¿›è¡Œä¼˜åŒ–å‰ï¼Œéœ€è¦å…ˆäº†è§£ç½‘ç»œå½“å‰çš„ç½‘ç»œçŠ¶å†µã€‚è¿™é‡Œä½¿ç”¨ `iperf3` è¿›è¡Œæµ‹è¯•ã€‚å‡ºäºç¯‡å¹…è€ƒè™‘ï¼Œå…·ä½“çš„å®‰è£…è¿‡ç¨‹ç•¥ã€‚

### 3.1. å‡†å¤‡

æœåŠ¡ç«¯çš„ WG å†…ç½‘ IPï¼š `10.8.0.100`
å®¢æˆ·ç«¯çš„ WG å†…ç½‘ IPï¼š `10.8.0.10`

åœ¨æœåŠ¡ç«¯è¿è¡Œä»¥ä¸‹å‘½ä»¤ä»¥å¯ç”¨ `iperf3` æœåŠ¡ç«¯

```bash
iperf3 -s
```

å¯åŠ¨åéœ€è¦åŒæ—¶æ”¾è¡Œ 5201 TCP ä¸ UDP ç«¯å£æ‰å¯æ­£å¸¸è®¿é—®

### 3.2. TCP æ€§èƒ½æµ‹è¯•

æˆ‘ä»¬éœ€è¦åŒæ—¶æµ‹è¯•æœåŠ¡ç«¯ -> å®¢æˆ·ç«¯ï¼ˆæœåŠ¡å™¨ä¸Šè¡Œï¼Œå®¢æˆ·ç«¯ä¸‹è¡Œï¼‰ä¸å®¢æˆ·ç«¯ -> æœåŠ¡ç«¯ï¼ˆæœåŠ¡ç«¯ä¸‹è¡Œï¼Œå®¢æˆ·ç«¯ä¸Šè¡Œï¼‰çš„ç½‘ç»œçŠ¶å†µï¼Œå…¶ä¸­

- å®¢æˆ·ç«¯ -> æœåŠ¡ç«¯ï¼šä»£è¡¨ç©å®¶çš„æ“ä½œæŒ‡ä»¤ï¼ˆå¦‚ç§»åŠ¨ã€ç ´åæ–¹å—ï¼‰å‘é€åˆ°æœåŠ¡å™¨ã€‚

- æœåŠ¡ç«¯ -> å®¢æˆ·ç«¯ï¼šä»£è¡¨æœåŠ¡å™¨çš„æ•°æ®ï¼ˆåœ°å›¾æ•°æ®ã€å®ä½“ï¼‰åŒæ­¥åˆ°ç©å®¶å®¢æˆ·ç«¯ã€‚

#### 3.2.1. æœåŠ¡ç«¯ä¸Šè¡Œï¼Œå®¢æˆ·ç«¯ä¸‹è¡Œæµ‹è¯•ï¼ˆæœåŠ¡ç«¯ -> å®¢æˆ·ç«¯ï¼‰

åœ¨å®¢æˆ·ç«¯æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ä»¥æµ‹è¯•æœåŠ¡ç«¯â†’å®¢æˆ·ç«¯çš„é€Ÿç‡

```bash
iperf3 -c 10.8.0.100 -R -t 20
```

ç¤ºä¾‹ç»“æœ

```txt
Connecting to host 10.8.0.100, port 5201
Reverse mode, remote host 10.8.0.100 is sending
[  5] local 10.8.0.10 port 63292 connected to 10.8.0.100 port 5201
[ ID] Interval           Transfer     Bitrate
[  5]   0.00-1.00   sec  1.50 MBytes  12.6 Mbits/sec
[  5]   1.00-2.02   sec  1.00 MBytes  8.27 Mbits/sec
[  5]   2.02-3.01   sec   384 KBytes  3.17 Mbits/sec
[  5]   3.01-4.00   sec   384 KBytes  3.16 Mbits/sec
[  5]   4.00-5.01   sec   384 KBytes  3.13 Mbits/sec
[  5]   5.01-6.00   sec   512 KBytes  4.20 Mbits/sec
[  5]   6.00-7.01   sec   512 KBytes  4.17 Mbits/sec
[  5]   7.01-8.01   sec   384 KBytes  3.15 Mbits/sec
[  5]   8.01-9.00   sec   640 KBytes  5.27 Mbits/sec
[  5]   9.00-10.00  sec   512 KBytes  4.19 Mbits/sec
[  5]  10.00-11.01  sec   512 KBytes  4.16 Mbits/sec
[  5]  11.01-12.01  sec   256 KBytes  2.10 Mbits/sec
[  5]  12.01-13.01  sec   640 KBytes  5.24 Mbits/sec
[  5]  13.01-14.01  sec   512 KBytes  4.17 Mbits/sec
[  5]  14.01-15.01  sec   384 KBytes  3.16 Mbits/sec
[  5]  15.01-16.00  sec   384 KBytes  3.16 Mbits/sec
[  5]  16.00-17.01  sec   384 KBytes  3.12 Mbits/sec
[  5]  17.01-18.00  sec   512 KBytes  4.23 Mbits/sec
[  5]  18.00-19.00  sec   384 KBytes  3.14 Mbits/sec
[  5]  19.00-20.01  sec   512 KBytes  4.15 Mbits/sec
- - - - - - - - - - - - - - - - - - - - - - - - -
[ ID] Interval           Transfer     Bitrate         Retr
[  5]   0.00-20.08  sec  11.0 MBytes  4.59 Mbits/sec   69            sender
[  5]   0.00-20.01  sec  10.5 MBytes  4.40 Mbits/sec                  receiver
```

**æ•°æ®åˆ†æ**ï¼š

- é€Ÿåº¦ä½ï¼šæ— è®ºæ˜¯å¹³å‡å¸¦å®½è¿˜æ˜¯æœ€é«˜å¸¦å®½éƒ½è¿œä½äºç‰©ç†å¸¦å®½
- æ³¢åŠ¨å¤§ï¼šé€Ÿåº¦æ›²çº¿å‘ˆé”¯é½¿çŠ¶ï¼ŒçŸ­çŸ­ 20 ç§’å†…é€Ÿåº¦åœ¨ 4 Â± 2 Mbps åå¤æ³¢åŠ¨
- é‡ä¼ å¼‚å¸¸ï¼šç†æƒ³çš„é‡ä¼ æ¬¡æ•°ä¸º 0ï¼Œè¿™é‡Œæœ‰ 69 æ¬¡ï¼Œçœ‹ä¼¼ä¸å¤šï¼Œä½†åœ¨é»˜è®¤ TCP ç®—æ³•ä¸‹ä¹Ÿè¶³ä»¥å¯¼è‡´ååé‡å´©æºƒã€‚

#### 3.2.2. æœåŠ¡ç«¯ä¸‹è¡Œï¼Œå®¢æˆ·ç«¯ä¸Šè¡Œæµ‹è¯•ï¼ˆå®¢æˆ·ç«¯ -> æœåŠ¡ç«¯ï¼‰

åœ¨å®¢æˆ·ç«¯æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ä»¥æµ‹è¯•æœåŠ¡ç«¯â†’å®¢æˆ·ç«¯çš„é€Ÿç‡

```bash
iperf3 -c 10.8.0.100 -t 20
```

ç¤ºä¾‹ç»“æœ

```txt
Connecting to host 10.8.0.100, port 5201
[  5] local 10.8.0.10 port 51859 connected to 10.8.0.100 port 5201
[ ID] Interval           Transfer     Bitrate
[  5]   0.00-1.01   sec  1.75 MBytes  14.6 Mbits/sec
[  5]   1.01-2.00   sec  1.62 MBytes  13.7 Mbits/sec
[  5]   2.00-3.01   sec  1.75 MBytes  14.5 Mbits/sec
[  5]   3.01-4.01   sec  1.75 MBytes  14.8 Mbits/sec
[  5]   4.01-5.00   sec  1.62 MBytes  13.7 Mbits/sec
[  5]   5.00-6.00   sec  1.75 MBytes  14.7 Mbits/sec
[  5]   6.00-7.01   sec  1.62 MBytes  13.5 Mbits/sec
[  5]   7.01-8.01   sec  2.12 MBytes  17.9 Mbits/sec
[  5]   8.01-9.01   sec  1.62 MBytes  13.7 Mbits/sec
[  5]   9.01-10.00  sec  1.75 MBytes  14.7 Mbits/sec
[  5]  10.00-11.01  sec  1.62 MBytes  13.5 Mbits/sec
[  5]  11.01-12.01  sec  1.62 MBytes  13.7 Mbits/sec
[  5]  12.01-13.00  sec  1.75 MBytes  14.7 Mbits/sec
[  5]  13.00-14.01  sec  1.75 MBytes  14.5 Mbits/sec
[  5]  14.01-15.01  sec  1.62 MBytes  13.7 Mbits/sec
[  5]  15.01-16.00  sec  1.75 MBytes  14.8 Mbits/sec
[  5]  16.00-17.01  sec  1.75 MBytes  14.6 Mbits/sec
[  5]  17.01-18.01  sec  1.62 MBytes  13.7 Mbits/sec
[  5]  18.01-19.00  sec  2.00 MBytes  16.9 Mbits/sec
[  5]  19.00-20.01  sec  2.00 MBytes  16.6 Mbits/sec
- - - - - - - - - - - - - - - - - - - - - - - - -
[ ID] Interval           Transfer     Bitrate
[  5]   0.00-20.01  sec  34.9 MBytes  14.6 Mbits/sec                  sender
[  5]   0.00-20.04  sec  34.8 MBytes  14.5 Mbits/sec                  receiver
```

**æ•°æ®åˆ†æ**ï¼š

- é“¾è·¯ä¸å¯¹ç§°ï¼šä¸Šè¡Œé€Ÿç‡ (14.6 Mbps) è¿œè¿œå¥½äº ä¸‹è¡Œé€Ÿç‡ (4.59 Mbps)ã€‚è¿™è¯æ˜äº†ç‰©ç†çº¿è·¯æœ¬èº«æ˜¯æœ‰æ½œåŠ›çš„ï¼ˆè‡³å°‘èƒ½è·‘ 15Mbps+ï¼‰ï¼Œé—®é¢˜å¯èƒ½åœ¨äºæœåŠ¡ç«¯å‘å®¢æˆ·ç«¯å‘é€æ•°æ®æ—¶ï¼ŒTCP åè®®å¤„ç†ä¸¢åŒ…çš„æ–¹å¼æ•ˆç‡ä½ä¸‹ã€‚

- ç¨³å®šæ€§å°šå¯ï¼šç›¸æ¯”äºä¸‹è¡Œå¸¦å®½çš„å‰§çƒˆæ³¢åŠ¨ï¼Œä¸Šè¡Œå¸¦å®½ç›¸å¯¹å¹³ç¨³ï¼ˆç»´æŒåœ¨ 13-17 Mbps ä¹‹é—´ï¼‰ã€‚

#### 3.2.3. ç»“è®º

ä¸Šè¿°æµ‹è¯•è¡¨æ˜æœåŠ¡ç«¯ -> å®¢æˆ·ç«¯å‡ºç°äº†ç“¶é¢ˆï¼Œå®é™…æ¸¸æˆè¿‡ç¨‹ä¸­ä¼šå‡ºç°å¦‚â€œæˆ‘æŒ–äº†æ–¹å—ï¼ˆæŒ‡ä»¤å‘å‡ºå»äº†ï¼‰ï¼Œä½†æ–¹å—è¿‡ä¸€ä¼šæ‰æ¶ˆå¤±ï¼ˆæœåŠ¡å™¨å›ä¼ çš„æ•°æ®å¡ä½äº†ï¼‰â€ç­‰çŠ¶å†µã€‚

é—®é¢˜ä¸»è¦é›†ä¸­åœ¨ä¸‹è¡Œé“¾è·¯ï¼ˆæœåŠ¡ç«¯ -> å®¢æˆ·ç«¯ï¼‰çš„ TCP æ‹¥å¡æ§åˆ¶ä¸Šï¼Œå› æ­¤æœ‰ä¸¤ä¸ªæ–¹å‘å¯å¾…ä¼˜åŒ–ï¼š

1. ä¸¢åŒ…ç‡
2. TCP æ‹¥å¡æ§åˆ¶ç®—æ³•

### 3.3. UDP é“¾è·¯ä½“è´¨æ£€æµ‹

å°½ç®¡æˆ‘ä»¬çš„ç›®æ ‡æ˜¯ä¼˜åŒ– TCP é“¾æ¥ï¼Œä½† UDP æµ‹è¯•å¯ç”¨äºæ‘¸æ¸…ç‰©ç†çº¿è·¯çš„çœŸå®è´¨é‡ï¼ˆå¸¦å®½ã€æŠ–åŠ¨ã€ä¸¢åŒ…ç‡ï¼‰ã€‚åªæœ‰ç¡¬æ€§æ¡ä»¶è¾¾æ ‡æ‰æœ‰ä¼˜åŒ–çš„æ½œåŠ›ï¼Œå¦åˆ™æ— è®ºå¦‚ä½•éƒ½éš¾ä»¥è¾¾åˆ°æ»¡æ„çš„æ•ˆæœã€‚

ä¿æŒæœåŠ¡ç«¯çš„ `iperf3` æœåŠ¡ç«¯å¼€å¯ï¼Œåœ¨å®¢æˆ·ç«¯æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```bash
iperf3 -c 10.8.0.100 -u -b 20M -R -t 10
```

ç¤ºä¾‹ç»“æœ

```txt
Connecting to host 10.8.0.100, port 5201
Reverse mode, remote host 10.8.0.100 is sending
[  5] local 10.8.0.10 port 55424 connected to 10.8.0.100 port 5201
[ ID] Interval           Transfer     Bitrate         Jitter    Lost/Total Datagrams
[  5]   0.00-1.00   sec  2.39 MBytes  20.0 Mbits/sec  0.044 ms  10/2145 (0.47%)
[  5]   1.00-2.01   sec  2.40 MBytes  19.9 Mbits/sec  0.032 ms  20/2166 (0.92%)
[  5]   2.01-3.01   sec  2.36 MBytes  19.9 Mbits/sec  0.052 ms  13/2123 (0.61%)
[  5]   3.01-4.00   sec  2.35 MBytes  19.9 Mbits/sec  0.053 ms  17/2119 (0.8%)
[  5]   4.00-5.01   sec  2.40 MBytes  19.9 Mbits/sec  0.031 ms  16/2163 (0.74%)
[  5]   5.01-6.01   sec  2.35 MBytes  19.8 Mbits/sec  0.056 ms  20/2119 (0.94%)
[  5]   6.01-7.00   sec  2.35 MBytes  19.9 Mbits/sec  0.039 ms  14/2113 (0.66%)
[  5]   7.00-8.01   sec  2.40 MBytes  19.9 Mbits/sec  0.037 ms  8/2152 (0.37%)
[  5]   8.01-9.01   sec  2.37 MBytes  19.9 Mbits/sec  0.060 ms  7/2121 (0.33%)
[  5]   9.01-10.01  sec  2.39 MBytes  19.9 Mbits/sec  0.054 ms  11/2143 (0.51%)
- - - - - - - - - - - - - - - - - - - - - - - - -
[ ID] Interval           Transfer     Bitrate         Jitter    Lost/Total Datagrams
[  5]   0.00-10.07  sec  24.0 MBytes  20.0 Mbits/sec  0.000 ms  0/21434 (0%)  sender
[SUM]  0.0-10.1 sec  7 datagrams received out-of-order
[  5]   0.00-10.01  sec  23.8 MBytes  19.9 Mbits/sec  0.054 ms  136/21364 (0.64%)  receiver
```

**ç»“æœåˆ†ææŒ‡æ ‡ï¼š**

| æŒ‡æ ‡           | ç†æƒ³å€¼            | æ•…éšœæ¡ˆä¾‹å€¼ | åˆ†æ               |
| :------------- | :---------------- | :--------- | :----------------- |
| Bitrate (å¸¦å®½) | è·‘æ»¡è®¾å®šå€¼ï¼ˆ20Mï¼‰ | 19.9 Mbps  | åˆæ ¼ï¼Œç‰©ç†å¸¦å®½å……è¶³ |
| Jitter (æŠ–åŠ¨)  | < 30ms            | 0.054 ms   | å»¶è¿Ÿç¨³å®šï¼Œé€‚åˆæ¸¸æˆ |
| Lost (ä¸¢åŒ…ç‡)  | 0%                | 0.64 %     | å­˜åœ¨éšæ‚£           |

### 3.4. è¯Šæ–­ç»“è®º

çº¿è·¯å±äº **â€œé«˜å¸¦å®½ã€ä½æŠ–åŠ¨ã€è½»å¾®ä¸¢åŒ…â€** ç±»å‹ã€‚

åŸå› åˆ†æï¼šå°½ç®¡ç½‘ç»œçš„ç‰©ç†æ¡ä»¶è¾¾æ ‡ï¼Œä½† Linux é»˜è®¤çš„ TCP æ‹¥å¡æ§åˆ¶ç®—æ³•ï¼ˆCubicï¼‰å¯¹ä¸¢åŒ…æå…¶æ•æ„Ÿï¼Œä¼šå°† 0.6% çš„ä¸¢åŒ…è¯¯åˆ¤ä¸ºç½‘ç»œä¸¥é‡æ‹¥å µï¼Œä»è€Œä¸»åŠ¨é™ä½å‘é€é€Ÿåº¦ï¼Œå¯¼è‡´â€œå®½å¸¦è·‘ä¸æ»¡â€ã€‚

> Cubic ç®—æ³•é€šè¿‡ç«‹æ–¹å‡½æ•°å¹³æ»‘è°ƒèŠ‚æ‹¥å¡çª—å£ã€‚åœ¨æ— ä¸¢åŒ…æ—¶çª—å£æŒ‰æ—¶é—´ä¸‰æ¬¡å‡½æ•°å¢é•¿ï¼Œé‡ä¸¢åŒ…åå¿«é€Ÿä¸‹é™å¹¶è¿›å…¥å¹³ç¨³æœŸï¼Œåˆ©ç”¨å‡½æ•°æ‹ç‚¹å®ç°é«˜å¸¦å®½åˆ©ç”¨ä¸RTTå…¬å¹³ã€‚ç®€å•æ¥è¯´ï¼Œå³é­é‡ä¸¢åŒ…åä¼šå¿«é€Ÿé™ä½å¸¦å®½ã€‚

## 4. ä¼˜åŒ–ç­–ç•¥

é’ˆå¯¹ä¸Šè¿°è¯Šæ–­ç»“æœï¼Œå¯é‡‡å–ä¸¤ä¸ªæªæ–½æ¥ä¼˜åŒ–ä¸¢åŒ…ç‡ï¼Œå¹¶å‡å°‘å› ä¸ºä¸¢åŒ…é€ æˆçš„ç½‘ç»œå¸¦å®½æ³¢åŠ¨ã€‚

### 4.1. é™ä½ WireGuard çš„ MTU

é˜²æ­¢å› ä¸º VPN å¤´éƒ¨å°è£…å¯¼è‡´æ•°æ®åŒ…è¶…è¿‡é“¾è·¯é™åˆ¶ï¼Œé€ æˆåˆ†ç‰‡æˆ–ä¸¢åŒ…ã€‚

**æ“ä½œå¯¹è±¡**ï¼š**å®¢æˆ·ç«¯**ã€**æœåŠ¡å™¨ç«¯**ä¸**ä¸­ç»§èŠ‚ç‚¹**

**é…ç½®å»ºè®®**ï¼šå°† MTU è®¾ç½®ä¸º WireGuard çš„å®‰å…¨ä¸‹é™å€¼ï¼š **1280**ã€‚

æ‰“å¼€ WireGuard çš„é…ç½®æ–‡ä»¶ï¼ˆå¦‚`wg0.conf`ï¼‰ï¼Œä½œå¦‚ä¸‹æ‰€ç¤ºçš„ä¿®æ”¹ï¼Œä»¥è®¾ç½®å…¶ MTU

```ini
[Interface]
# ... å…¶ä»–é…ç½® ...
MTU = 1280
```

ä¿®æ”¹åéœ€é‡å¯ WireGuardã€‚

**ä»£ä»·**ï¼š

å°½ç®¡é™ä½ MTU èƒ½æœ‰æ•ˆé¿å…åˆ†ç‰‡å¯¼è‡´çš„ä¸¢åŒ…é»‘æ´ï¼Œä½†è¾ƒä½çš„ MTU ä¹Ÿä¼šå¸¦æ¥ä»¥ä¸‹å‰¯ä½œç”¨ï¼š

- åè®®å¼€é”€å¢åŠ ï¼šæ¯ä¸ªæ•°æ®åŒ…éƒ½åŒ…å«å›ºå®šçš„å¤´éƒ¨ä¿¡æ¯ï¼ˆIPå¤´ + UDPå¤´ + WireGuardåŠ å¯†å¤´ = çº¦ 60-80 å­—èŠ‚ï¼‰ã€‚MTU è¶Šå°ï¼Œæœ‰æ•ˆè½½è·çš„å æ¯”å°±è¶Šä½ã€‚è¿™æ„å‘³ç€ä¼ è¾“åŒæ ·å¤§å°çš„æ–‡ä»¶ï¼Œéœ€è¦å‘é€æ›´å¤šçš„æ•°æ®åŒ…ï¼Œå¸¦å®½åˆ©ç”¨ç‡ä¼šæœ‰è½»å¾®ä¸‹é™ï¼ˆçº¦ä¸‹é™ 2% - 5%ï¼‰ã€‚

- CPU è´Ÿè½½ä¸Šå‡ï¼šç”±äºå•ä¸ªåŒ…æºå¸¦çš„æ•°æ®å˜å°‘ï¼Œä¸ºäº†ç»´æŒåŒæ ·çš„æ€»ä¼ è¾“é€Ÿç‡ï¼Œç³»ç»Ÿæ¯ç§’éœ€è¦å¤„ç†çš„æ•°æ®åŒ…æ•°é‡ä¼šå¢åŠ ã€‚è¿™ä¼šå¢åŠ  CPU åœ¨ä¸­æ–­å¤„ç†ã€è·¯ç”±æŸ¥æ‰¾ä»¥åŠ WireGuard åŠ å¯†/è§£å¯†è¿ç®—ä¸Šçš„å‹åŠ›ã€‚å°½ç®¡è¿™äº›å¢åŠ çš„è®¡ç®—å‹åŠ›å½±å“é€šå¸¸æå…¶è½»å¾®ï¼Œä½†å¯¹äºæ€§èƒ½æå¼±çš„è·¯ç”±å™¨æˆ–å•æ ¸ VPSï¼Œå¯èƒ½ä¼šæˆä¸ºé«˜è´Ÿè½½ä¸‹çš„ç“¶é¢ˆã€‚

- å¤§æ–‡ä»¶ä¼ è¾“æ•ˆç‡ç•¥é™ï¼šå¯¹äºæ¸¸æˆæ•°æ®ï¼ˆä»¥å°åŒ…ä¸ºä¸»ï¼‰çš„å½±å“å¾®ä¹å…¶å¾®ï¼Œä½†è¿›è¡Œå¤§æ–‡ä»¶ä¼ è¾“æ—¶é€Ÿåº¦ä¸Šé™æ—¶ç›¸å¯¹è¾ƒé«˜ MTUï¼ˆ1500ï¼‰ä¼šç•¥ä½ã€‚

ä½†å¯¹äºæ¸¸æˆæœåŠ¡å™¨åœºæ™¯ï¼Œç¨³å®šæ€§ >> æé™å¸¦å®½ï¼Œç‰ºç‰²å¾®å°çš„å¸¦å®½æ•ˆç‡å’Œ CPU æ€§èƒ½æ¥æ¢å–è¿æ¥ç¨³å®šæ€§æ˜¯å®Œå…¨å€¼å¾—çš„ã€‚

### 4.2. å¯ç”¨ BBR æ‹¥å¡æ§åˆ¶ç®—æ³•

Linux é»˜è®¤çš„ Cubic æ‹¥å¡æ§åˆ¶ç®—æ³•åœ¨é­é‡ä¸¢åŒ…æ—¶ä¼šå¤§å¹…é™ä½å¸¦å®½ï¼Œé€ æˆå¸¦å®½æ³¢åŠ¨ï¼Œåœ¨å­˜åœ¨ä¸¢åŒ…çš„ç¯å¢ƒä¸‹é€šå¸¸ä¼šæ˜¾è‘—å½±å“å¸¦å®½è¡¨ç°ã€‚

Google çš„ BBR ç®—æ³•ä¸ä»¥ä¸¢åŒ…ä½œä¸ºæ‹¥å¡åˆ¤æ–­æ ‡å‡†ï¼Œè€Œæ˜¯åŸºäºâ€œå¸¦å®½å’Œå»¶è¿Ÿâ€çš„æ¨¡å‹ã€‚BBR é€šè¿‡æµ‹é‡ç½‘ç»œç“¶é¢ˆå¸¦å®½å’Œæœ€å°å¾€è¿”æ—¶å»¶æ¥æ™ºèƒ½è°ƒèŠ‚å‘åŒ…é€Ÿç‡ï¼Œä»¥å¯¹æŠ—ç½‘ç»œæ‹¥å¡å¹¶è·å¾—æ›´é«˜ååä¸æ›´ä½å»¶è¿Ÿã€‚è¿™ä½¿å¾—å®ƒèƒ½å¿½ç•¥çº¿è·¯ä¸Šçš„ç‰©ç†éšæœºä¸¢åŒ…ï¼Œå¼ºè¡Œåˆ©ç”¨å‰©ä½™å¸¦å®½ã€‚

å› æ­¤ï¼Œé€šè¿‡å°† Linux é»˜è®¤çš„ TCP æ‹¥å¡æ§åˆ¶ç®—æ³•ä» Cubic æ›¿æ¢ä¸º BBR é€šå¸¸å¯ä»¥æœ‰æ•ˆæ”¹å–„å¸¦å®½è¡¨ç°ã€‚

**æ“ä½œå¯¹è±¡**ï¼š **æœåŠ¡å™¨ç«¯**ä»¥åŠ**ä¸­ç»§èŠ‚ç‚¹**ã€‚

**æ“ä½œæ­¥éª¤**ï¼š

æ‰“å¼€ `/etc/sysctl.conf` æ–‡ä»¶ï¼Œåœ¨æ–‡ä»¶æœ«å°¾æ·»åŠ ä»¥ä¸‹é…ç½®é¡¹

```conf
# ... å…¶ä»–é…ç½®é¡¹ ...

net.core.default_qdisc=fq
net.ipv4.tcp_congestion_control=bbr
```

ç„¶åæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ä»¥é‡æ–°åŠ è½½ `/etc/sysctl.conf`

```bash
sudo sysctl -p
```

éªŒè¯çŠ¶æ€

```bash
sysctl net.ipv4.tcp_congestion_control
# è¾“å‡ºåº”ä¸º: net.ipv4.tcp_congestion_control = bbr
```

## 5. ä¼˜åŒ–åæ•ˆæœéªŒè¯

å†æ¬¡æ‰§è¡Œä»¥ä¸‹å‘½ä»¤è¿è¡Œ TCP æµ‹è¯•

```bash
iperf3 -c 10.8.0.100 -R -t 20
```

ç¤ºä¾‹ç»“æœ

```txt
Connecting to host 10.8.0.100, port 5201
Reverse mode, remote host 10.8.0.100 is sending
[  5] local 10.8.0.10 port 63878 connected to 10.8.0.100 port 5201
[ ID] Interval           Transfer     Bitrate
[  5]   0.00-1.01   sec  5.12 MBytes  42.5 Mbits/sec
[  5]   1.01-2.01   sec  5.38 MBytes  45.1 Mbits/sec
[  5]   2.01-3.01   sec  5.50 MBytes  46.1 Mbits/sec
[  5]   3.01-4.01   sec  5.62 MBytes  47.2 Mbits/sec
[  5]   4.01-5.01   sec  5.38 MBytes  45.2 Mbits/sec
[  5]   5.01-6.00   sec  5.62 MBytes  47.5 Mbits/sec
[  5]   6.00-7.01   sec  5.38 MBytes  44.6 Mbits/sec
[  5]   7.01-8.01   sec  5.50 MBytes  46.5 Mbits/sec
[  5]   8.01-9.00   sec  5.50 MBytes  46.2 Mbits/sec
[  5]   9.00-10.00  sec  5.38 MBytes  45.2 Mbits/sec
[  5]  10.00-11.01  sec  5.25 MBytes  43.5 Mbits/sec
[  5]  11.01-12.01  sec  6.00 MBytes  50.5 Mbits/sec
[  5]  12.01-13.00  sec  5.50 MBytes  46.4 Mbits/sec
[  5]  13.00-14.00  sec  5.38 MBytes  45.1 Mbits/sec
[  5]  14.00-15.00  sec  4.12 MBytes  34.7 Mbits/sec
[  5]  15.00-16.01  sec  5.62 MBytes  46.6 Mbits/sec
[  5]  16.01-17.01  sec  5.50 MBytes  46.1 Mbits/sec
[  5]  17.01-18.00  sec  5.50 MBytes  46.8 Mbits/sec
[  5]  18.00-19.01  sec  5.50 MBytes  45.5 Mbits/sec
[  5]  19.01-20.01  sec  5.12 MBytes  43.1 Mbits/sec
- - - - - - - - - - - - - - - - - - - - - - - - -
[ ID] Interval           Transfer     Bitrate         Retr
[  5]   0.00-20.00  sec   112 MBytes  46.8 Mbits/sec  9277            sender
[  5]   0.00-20.01  sec   108 MBytes  45.2 Mbits/sec                  receiver
```

**é¢„æœŸç»“æœå¯¹æ¯”**ï¼š

| æŒ‡æ ‡        | ä¼˜åŒ–å‰   | ä¼˜åŒ–å   | è¯´æ˜                                                                                             |
| ----------- | -------- | -------- | ------------------------------------------------------------------------------------------------ |
| å¹³å‡å¸¦å®½    | 4.5 Mbps | 45 Mbps  | é€Ÿåº¦æå‡ 10 å€ï¼Œè·‘æ»¡ç‰©ç†å¸¦å®½                                                                     |
| ç¨³å®šæ€§      | æä¸ç¨³å®š | éå¸¸å¹³ç¨³ | è§£å†³å¡é¡¿é—®é¢˜çš„å…³é”®                                                                               |
| Retr (é‡ä¼ ) | 50       | ~9000+   | æ³¨æ„ï¼šBBR æ¨¡å¼ä¸‹é«˜é‡ä¼ æ˜¯æ­£å¸¸çš„ã€‚å®ƒä»£è¡¨ç®—æ³•åœ¨æ¿€è¿›åœ°æŠµæŠ—ç‰©ç†ä¸¢åŒ…ï¼Œåªè¦é€Ÿåº¦è¾¾æ ‡ï¼Œæ— éœ€ç†ä¼šé«˜é‡ä¼ æ•°ã€‚ |

### 5.1. æ—¶åºå›¾è¯´æ˜

**ä¼˜åŒ–å‰**ï¼š

```mermaid
sequenceDiagram
    autonumber
    participant C as å®¢æˆ·ç«¯ (10.8.0.10)
    participant R as ä¸­ç»§èŠ‚ç‚¹ (Relay)
    participant S as æœåŠ¡ç«¯ (10.8.0.100)

    Note over C, S: åœºæ™¯ï¼šé»˜è®¤ Cubic ç®—æ³• + é»˜è®¤ MTU (ä¼˜åŒ–å‰)

    %% ä¸Šè¡Œé˜¶æ®µ
    C->>R: å‘é€æ¸¸æˆæŒ‡ä»¤
    R->>S: é€ä¼ åŠ å¯†æµé‡
    
    %% ä¸‹è¡Œé˜¶æ®µ - é‡ç‚¹å±•ç¤º Cubic è¡Œä¸º
    rect rgb(255, 240, 240)
        Note right of S: ğŸ¢ Cubic ç®—æ³•å‘é€
        S->>R: å°è¯•å‘é€æ•°æ®åŒ… Batch 1
        R->>C: è½¬å‘æ•°æ®åŒ… 1, 2, 3
        
        %% æ¨¡æ‹Ÿä¸¢åŒ…
        R--xC: âŒ æ•°æ®åŒ… 4 åœ¨ç‰©ç†çº¿è·¯ä¸¢å¤± (0.6% ä¸¢åŒ…ç‡)
        
        Note right of S: âš ï¸ Cubic åˆ¤å®šï¼š<br/>æ£€æµ‹åˆ°ä¸¢åŒ… = ç½‘ç»œä¸¥é‡æ‹¥å µï¼<br/>å†³ ç­–ï¼šç«‹å³æŠŠå‘é€çª—å£å‡åŠ (ä¹˜æ³•å‡å°)
        
        S-->>R: (æš‚åœå‘é€ï¼Œç­‰å¾…è¶…æ—¶æˆ–ACK)
        S->>R: æ…¢é€Ÿé‡ä¼ åŒ… 4... (é€Ÿåº¦éª¤é™)
        R->>C: ç¨€ç–çš„æ•°æ®æµ (4.5Mbps)
    end

    Note left of C: ç»“æœï¼šåœ°å›¾åŠ è½½å¡ä½<br/>ç©å®¶çœ‹åˆ°è™šç©ºï¼Œæ“ä½œå›æ¡£
```

**ä¼˜åŒ–å**ï¼š

```mermaid
sequenceDiagram
    autonumber
    participant C as å®¢æˆ·ç«¯ (10.8.0.10)
    participant R as ä¸­ç»§èŠ‚ç‚¹ (Relay)
    participant S as æœåŠ¡ç«¯ (10.8.0.100)

    Note over C, S: åœºæ™¯ï¼šå¼€å¯ BBR + MTU 1280 ä¼˜åŒ–å

    %% ä¸Šè¡Œé˜¶æ®µ
    C->>R: å‘é€æ¸¸æˆæŒ‡ä»¤ (å¦‚ï¼šç ´åæ–¹å—)
    R->>S: é€ä¼ åŠ å¯†æµé‡ (WireGuard)
    
    Note over S: æ¸¸æˆé€»è¾‘å¤„ç†å®Œæˆ<br/>å‡†å¤‡å›ä¼ åŒºå—(Chunk)æ•°æ®

    %% ä¸‹è¡Œé˜¶æ®µ - é‡ç‚¹å±•ç¤º BBR è¡Œä¸º
    rect rgb(240, 248, 255)
        Note right of S: ğŸš€ BBR ç®—æ³•æ¥ç®¡å‘é€
        S->>R: æ»¡å¸¦å®½å‘é€æ•°æ®åŒ… Batch 1
        R->>C: è½¬å‘æ•°æ®åŒ… 1, 2, 3
        
        %% æ¨¡æ‹Ÿä¸¢åŒ…åœºæ™¯
        R--xC: âŒ æ•°æ®åŒ… 4 åœ¨ç‰©ç†çº¿è·¯ä¸¢å¤± (0.6% ä¸¢åŒ…ç‡)
        
        Note right of S: âš¡ BBR åˆ¤å®šï¼š<br/>æ£€æµ‹åˆ°ä¸¢åŒ…ï¼Œä½†å¸¦å®½æ¨¡å‹æ˜¾ç¤ºé“¾è·¯æœªæ»¡<br/>å†³ ç­–ï¼šç»´æŒå¤§çª—å£ï¼Œä¸é™é€Ÿï¼
        
        S->>R: ç«‹å³é‡ä¼ åŒ… 4 + å‘é€æ–°åŒ… 5, 6, 7...
        R->>C: æŒç»­é«˜é€Ÿæ•°æ®æµ (45Mbps)
    end

    Note left of C: ç»“æœï¼šè™½ç„¶æœ‰é‡ä¼  (Retré«˜)<br/>ä½†æ•°æ®æµæœªä¸­æ–­ï¼Œæ¸¸æˆä¸æ»‘
```

## 6. æ€»ç»“

1. **å¯¹äº TCP ä¸šåŠ¡ (å¦‚ Minecraft Java)**ï¼šåœ¨æœ‰è½»å¾®ä¸¢åŒ…çš„çº¿è·¯ä¸Šï¼Œ**å¼€å¯ BBR æ˜¯å¿…é¡»çš„**ã€‚å®ƒèƒ½å°†â€œä¸å¯ç©â€çš„ç½‘ç»œå˜æˆâ€œæµç•…â€çš„ç½‘ç»œã€‚
2. **å¯¹äº UDP ä¸šåŠ¡ (Minecraft Bedrock)**ï¼šBBR æ— æ³•ä¼˜åŒ– UDP åè®®ã€‚å¦‚æœç‰©ç†çº¿è·¯ä¸¢åŒ…ç‡æŒç»­é«˜äº 1%ï¼Œå¯èƒ½ä¼šå‡ºç°è½»å¾®å›æ¡£ï¼Œä½† BBR å¸¦æ¥çš„å¸¦å®½çº¢åˆ©èƒ½ä¿è¯æ•´ä½“è¿æ¥ä¸ä¸­æ–­ã€‚
3. **MTU 1280** æ˜¯ WireGuard ç»„ç½‘ä¸­æœ€ç¨³å¦¥çš„è®¾ç½®ï¼Œèƒ½æœ‰æ•ˆé¿å…å¤§é‡éšæ€§çš„è¿æ¥è¶…æ—¶é—®é¢˜ã€‚
